<div class="border border-gray-200 dark:border-zinc-800 rounded-lg overflow-hidden flex flex-col" [class.flex-1]="expanded()" [class.min-h-0]="expanded()">
  <!-- Header -->
  <div class="flex items-center justify-between px-3 py-2 bg-purple-50 dark:bg-purple-950/30 border-b border-gray-200 dark:border-zinc-800 flex-none">
    <button
      (click)="toggleExpanded()"
      class="flex items-center gap-1.5 text-xs font-semibold text-purple-700 dark:text-purple-400 hover:text-purple-900 dark:hover:text-purple-300 transition-colors"
    >
      <span class="text-[10px]">{{ expanded() ? '▼' : '▶' }}</span>
      Test as User
    </button>
    @if (expanded()) {
      <button
        (click)="newSession()"
        class="text-xs text-purple-600 dark:text-purple-400 hover:text-purple-800 dark:hover:text-purple-300 transition-colors"
        title="Start a fresh session"
      >New session</button>
    }
  </div>

  @if (expanded()) {
    <!-- Session indicator -->
    <div class="px-3 py-1 bg-purple-50/50 dark:bg-purple-950/10 border-b border-gray-100 dark:border-zinc-800 flex-none">
      <span class="text-[10px] text-gray-400 dark:text-zinc-500">Test session</span>
    </div>

    <!-- Files row -->
    <div class="grid grid-cols-2 gap-3 p-3 border-b border-gray-100 dark:border-zinc-800 flex-none bg-white dark:bg-zinc-900">
      <app-file-list
        title="Input files"
        [files]="inputFiles()"
        emptyMessage="Upload files for the agent"
        [uploadFn]="uploadFile"
        [downloadFn]="downloadFile"
        [deleteFn]="deleteFile"
        [viewFn]="readFile"
        [saveFn]="saveFile"
        (refreshed)="refreshInputFiles()"
        (fileOpened)="fileOpened.emit()"
      />
      <app-file-list
        title="Output files"
        [files]="outputFiles()"
        emptyMessage="Agent output appears here"
        [allowUpload]="false"
        [downloadFn]="downloadFile"
        [deleteFn]="deleteFile"
        [viewFn]="readFile"
        [saveFn]="saveFile"
        (refreshed)="refreshOutputFiles()"
        (fileOpened)="fileOpened.emit()"
      />
    </div>

    <!-- Chat — flex-1 min-h-0 must be on the host element, matching how the
         developer chat is used so that h-full inside the template resolves. -->
    <app-chat
      class="flex-1 min-h-0"
      role="user"
      [sessionId]="sessionId()"
      [compact]="true"
      placeholder="Test as user…"
      (sessionCreated)="onSessionCreated($event)"
      (filesChanged)="onFilesChanged($event)"
      (settingsRequired)="settingsRequired.emit()"
    />
  }
</div>
