<div class="flex flex-col h-full min-h-0" [class.text-sm]="compact">

  <!-- Agent activity panel: thinking + tool calls, shown when present -->
  @if (thinkingBlocks().length > 0) {
    <div
      class="flex-none flex flex-col bg-gray-50 dark:bg-zinc-900 overflow-hidden"
      [style.height.px]="thinkingPanelHeight()"
    >
      <!-- Panel header -->
      <div class="flex-none flex items-center gap-2 px-3 py-1.5 border-b border-gray-200 dark:border-zinc-700">
        <span class="text-[10px] font-semibold uppercase tracking-widest text-gray-400 dark:text-zinc-500">Agent activity</span>
        @if (streaming()) {
          <span class="ml-auto flex gap-0.5">
            <span class="w-1 h-1 bg-brand rounded-full animate-bounce [animation-delay:-0.3s]"></span>
            <span class="w-1 h-1 bg-brand rounded-full animate-bounce [animation-delay:-0.15s]"></span>
            <span class="w-1 h-1 bg-brand rounded-full animate-bounce"></span>
          </span>
        }
      </div>
      <!-- Scrollable content -->
      <div #thinkingList class="flex-1 overflow-y-auto scrollbar-thin px-3 py-2 space-y-1.5 min-h-0">
        @for (block of thinkingBlocks(); track $index) {
          @if (isThinkingBlock(block)) {
            <app-thinking-block [block]="block" />
          } @else {
            <app-tool-call-block [block]="block" />
          }
        }
      </div>
    </div>

    <!-- Drag handle / resizable divider -->
    <div
      class="flex-none h-2 flex items-center justify-center cursor-row-resize
             border-y border-gray-200 dark:border-zinc-700
             bg-gray-100 dark:bg-zinc-800
             hover:bg-brand/20 dark:hover:bg-brand/20 transition-colors select-none"
      (mousedown)="onDividerMouseDown($event)"
    >
      <div class="w-10 h-0.5 rounded-full bg-gray-300 dark:bg-zinc-600"></div>
    </div>
  }

  <!-- Message list -->
  <div
    #messageList
    class="flex-1 min-h-0 overflow-y-auto px-4 py-4 space-y-1 scrollbar-thin"
    [class.px-2]="compact"
    [class.py-2]="compact"
  >
    @if (messages().length === 0) {
      <div class="flex h-full items-center justify-center">
        <p class="text-gray-400 dark:text-zinc-500 text-sm italic">
          {{ role === 'developer' ? 'Start a conversation to author or manage skillsâ€¦' : 'How can I help you today?' }}
        </p>
      </div>
    }
    @for (message of messages(); track message.id) {
      @if (hasVisibleContent(message)) {
        <app-message-bubble [message]="message" />
      }
    }
    @if (streaming()) {
      <div class="flex gap-1 px-4 pb-2">
        <span class="w-1.5 h-1.5 bg-brand rounded-full animate-bounce [animation-delay:-0.3s]"></span>
        <span class="w-1.5 h-1.5 bg-brand rounded-full animate-bounce [animation-delay:-0.15s]"></span>
        <span class="w-1.5 h-1.5 bg-brand rounded-full animate-bounce"></span>
      </div>
    }
  </div>

  <!-- Input area -->
  <div class="flex-none border-t border-gray-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 p-3" [class.p-2]="compact">
    <div class="flex gap-2 items-end">
      <textarea
        class="flex-1 resize-none rounded-xl border border-gray-200 dark:border-zinc-700 bg-white dark:bg-zinc-800 text-gray-900 dark:text-zinc-50 placeholder:text-gray-400 dark:placeholder:text-zinc-500 px-3 py-2 text-sm focus:outline-none focus:border-amber-400 dark:focus:border-amber-500 transition-colors max-h-40 scrollbar-thin"
        [class.text-xs]="compact"
        [rows]="compact ? 1 : 2"
        [placeholder]="placeholder"
        [value]="inputText()"
        (input)="inputText.set($any($event.target).value)"
        (keydown)="onKeydown($event)"
        [disabled]="streaming()"
      ></textarea>
      @if (streaming()) {
        <button
          (click)="stop()"
          class="flex-none px-4 py-2 rounded-xl bg-red-500 hover:bg-red-600 text-white text-sm font-medium transition-colors flex items-center gap-1.5"
          [class.px-3]="compact"
          [class.py-1.5]="compact"
          [class.text-xs]="compact"
          title="Stop generation"
        >
          <svg class="w-3 h-3 flex-none" viewBox="0 0 12 12" fill="currentColor">
            <rect x="2" y="2" width="8" height="8" rx="1"/>
          </svg>
          <span>Stop</span>
        </button>
      } @else {
        <button
          (click)="send()"
          [disabled]="!inputText().trim()"
          class="flex-none px-4 py-2 rounded-xl bg-brand text-zinc-900 text-sm font-medium hover:bg-brand-500 disabled:opacity-40 disabled:cursor-not-allowed transition-colors"
          [class.px-3]="compact"
          [class.py-1.5]="compact"
          [class.text-xs]="compact"
        >Send</button>
      }
    </div>
  </div>
</div>
